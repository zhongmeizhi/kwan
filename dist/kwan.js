!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("@/tools/base.js")):"function"==typeof define&&define.amd?define(["@/tools/base.js"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).kwan=e(t.base_js)}(this,(function(t){"use strict";function e(t){return"number"==typeof t}const s=Array.isArray;function i(t){throw new Error(t)}const h=new Set(["click","mousemove","mouseenter","mouseleave"]);class n{constructor(t){this.run=t,this._running=!1,this.requestAnimationFrame=this._getRaf()}start(){this._running=!0,this._runRaf()}stop(){this._running=!1}_runRaf(){const t=()=>{this.run(),this._running&&this.requestAnimationFrame(t)};this.requestAnimationFrame(t)}_getRaf(){return"undefined"!=typeof window&&(window.requestAnimationFrame&&window.requestAnimationFrame.bind(window)||window.msRequestAnimationFrame&&window.msRequestAnimationFrame.bind(window)||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(t){return setTimeout(t,16)}}}var a={Rect:class extends class extends class{constructor(){this.events={}}addEventListener(e,s){if(!t.isFn(s))return t.errorHandler("监听对象不是一个函数");h.has(e)&&(this.events[e]||(this.events[e]=new Set),this.events[e].add(s))}dispatchEvent(t,e){this.events[t]&&this.events[t].forEach(t=>t.call(this,e))}removeEventListener(t,e){this.events[t]&&(this.events[t]&&e?1===this.events[t].size?delete this.events[t]:this.events[t].delete(e):delete this.events[t])}}{constructor(t){super(),this.attrs=t,this.paths=[],this.dirty=!1,this.createPath()}setAttrs(t={}){this.attrs=Object.assign({},this.attrs,t),(t.pos||t.size||t.borderRadius)&&(this.paths=[],this.createPath())}createPath(){i("render 需要被重写")}isPointInPath(){i("isPointInPath 需要被重写")}draw(t){t.save(),t.beginPath();const{border:s,background:i,boxShadow:h,opacity:n}=this.attrs;if(e(n)&&(t.globalAlpha=n),h){const[e,s,i,n]=h;t.shadowColor=e,t.shadowOffsetX=s,t.shadowOffsetY=i,t.shadowBlur=n}if(this.paths.forEach(({type:e,args:s})=>{t[e](...s)}),s){const[e,i,h]=s;e&&i&&h&&(t.lineWidth=e,t.strokeStyle=h),t.stroke()}i&&(t.fillStyle=i,t.fill()),t.closePath(),t.restore()}}{constructor(t){super(t)}createPath(){const{pos:t,size:e,borderRadius:s}=this.attrs,[i,h]=t,[n,a]=e,o=s||0;o?this._buildPath(i,h,n,a,o):this.paths.push({type:"rect",args:[i,h,n,a]})}isPointInPath(t){const{offsetX:e,offsetY:s}=t,{pos:i,border:h,size:n}=this.attrs,[a,o]=i,[r,d]=n;return e>a&&e<a+r&&s>o&&s<o+d}_transformRadius(t,i,h){var n,a,o,r,d;return e(t)?n=a=o=r=t:s(t)?1===t.length?n=a=o=r=t[0]:2===t.length?(n=o=t[0],a=r=t[1]):3===t.length?(n=t[0],a=r=t[1],o=t[2]):(n=t[0],a=t[1],o=t[2],r=t[3]):n=a=o=r=0,n+a>i&&(n*=i/(d=n+a),a*=i/d),o+r>i&&(o*=i/(d=o+r),r*=i/d),a+o>h&&(a*=h/(d=a+o),o*=h/d),n+r>h&&(n*=h/(d=n+r),r*=h/d),[n,a,o,r]}_buildPath(t,e,s,i,h){s<0&&(t+=s,s=-s),i<0&&(e+=i,i=-i);const[n,a,o,r]=this._transformRadius(h,s,i);this.paths.push({type:"moveTo",args:[t+n,e]}),this.paths.push({type:"arcTo",args:[t+s,e,t+s,e+a,a]}),this.paths.push({type:"arcTo",args:[t+s,e+i,t+s-o,e+i,o]}),this.paths.push({type:"arcTo",args:[t,e+i,t,e+i-r,r]}),this.paths.push({type:"arcTo",args:[t,e,t+n,e,n]})}}};return{Scene:class{constructor(t,{width:e,height:s,hd:i=!0}){if(!(t&&t instanceof HTMLElement))throw new Error("不能找到匹配的 DOM 元素");const h=document.createElement("canvas");this.ctx=h.getContext("2d"),this.width=e,this.height=s,this.shapes=[],this._initHd(h,i),this._initEvent(h),t.appendChild(h)}_initHd(t,e){if(!e)return;const s=window.devicePixelRatio;t.style.width=this.width+"px",t.style.height=this.height+"px",t.width=this.width*s,t.height=this.height*s,this.ctx.scale(s,s),this.ctx.save()}_initEvent(t){this.hoverShapeSet=new Set,t.addEventListener("click",this.onClick.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this))}_traverseShapes(t){const e=this.shapes.length;for(let s=0;s<e;s++){const e=this.shapes[s];"function"==typeof t&&t(e)}}append(t){this.loop||(this.loop=new n(this.update.bind(this)),this.loop.start()),this.shapes.push(t)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}update(){this.ctx.clearRect(0,0,this.width,this.height),this._traverseShapes(t=>t.draw(this.ctx))}onClick(t){this._traverseShapes(e=>{e.events.click&&e.isPointInPath(t)&&e.dispatchEvent("click")})}onMouseMove(t){this._traverseShapes(e=>{(e.events.mousemove||e.events.mouseenter||e.events.mouseleave)&&(e.isPointInPath(t)?(this.hoverShapeSet.has(e)||e.dispatchEvent("mouseenter"),e.dispatchEvent("mousemove"),this.hoverShapeSet.add(e)):this.hoverShapeSet.has(e)&&(e.dispatchEvent("mouseleave"),this.hoverShapeSet.delete(e)))})}},shapes:a}}));
