import{isFn as t,errorHandler as e}from"@/tools/base.js";function s(t){return"number"==typeof t}const i=Array.isArray;function h(t){throw new Error(t)}const n=new Set(["click","mousemove","mouseenter","mouseleave"]);class a{constructor(t){this.run=t,this._running=!1,this.requestAnimationFrame=this._getRaf()}start(){this._running=!0,this._runRaf()}stop(){this._running=!1}_runRaf(){const t=()=>{this.run(),this._running&&this.requestAnimationFrame(t)};this.requestAnimationFrame(t)}_getRaf(){return"undefined"!=typeof window&&(window.requestAnimationFrame&&window.requestAnimationFrame.bind(window)||window.msRequestAnimationFrame&&window.msRequestAnimationFrame.bind(window)||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)||function(t){return setTimeout(t,16)}}}var r={Rect:class extends class extends class{constructor(){this.events={}}addEventListener(s,i){if(!t(i))return e("监听对象不是一个函数");n.has(s)&&(this.events[s]||(this.events[s]=new Set),this.events[s].add(i))}dispatchEvent(t,e){this.events[t]&&this.events[t].forEach(t=>t.call(this,e))}removeEventListener(t,e){this.events[t]&&(this.events[t]&&e?1===this.events[t].size?delete this.events[t]:this.events[t].delete(e):delete this.events[t])}}{constructor(t){super(),this.attrs=t,this.paths=[],this.dirty=!1,this.createPath()}setAttrs(t={}){this.attrs=Object.assign({},this.attrs,t),(t.pos||t.size||t.borderRadius)&&(this.paths=[],this.createPath())}createPath(){h("render 需要被重写")}isPointInPath(){h("isPointInPath 需要被重写")}draw(t){t.save(),t.beginPath();const{border:e,background:i,boxShadow:h,opacity:n}=this.attrs;if(s(n)&&(t.globalAlpha=n),h){const[e,s,i,n]=h;t.shadowColor=e,t.shadowOffsetX=s,t.shadowOffsetY=i,t.shadowBlur=n}if(this.paths.forEach(({type:e,args:s})=>{t[e](...s)}),e){const[s,i,h]=e;s&&i&&h&&(t.lineWidth=s,t.strokeStyle=h),t.stroke()}i&&(t.fillStyle=i,t.fill()),t.closePath(),t.restore()}}{constructor(t){super(t)}createPath(){const{pos:t,size:e,borderRadius:s}=this.attrs,[i,h]=t,[n,a]=e,r=s||0;r?this._buildPath(i,h,n,a,r):this.paths.push({type:"rect",args:[i,h,n,a]})}isPointInPath(t){const{offsetX:e,offsetY:s}=t,{pos:i,border:h,size:n}=this.attrs,[a,r]=i,[o,c]=n;return e>a&&e<a+o&&s>r&&s<r+c}_transformRadius(t,e,h){var n,a,r,o,c;return s(t)?n=a=r=o=t:i(t)?1===t.length?n=a=r=o=t[0]:2===t.length?(n=r=t[0],a=o=t[1]):3===t.length?(n=t[0],a=o=t[1],r=t[2]):(n=t[0],a=t[1],r=t[2],o=t[3]):n=a=r=o=0,n+a>e&&(n*=e/(c=n+a),a*=e/c),r+o>e&&(r*=e/(c=r+o),o*=e/c),a+r>h&&(a*=h/(c=a+r),r*=h/c),n+o>h&&(n*=h/(c=n+o),o*=h/c),[n,a,r,o]}_buildPath(t,e,s,i,h){s<0&&(t+=s,s=-s),i<0&&(e+=i,i=-i);const[n,a,r,o]=this._transformRadius(h,s,i);this.paths.push({type:"moveTo",args:[t+n,e]}),this.paths.push({type:"arcTo",args:[t+s,e,t+s,e+a,a]}),this.paths.push({type:"arcTo",args:[t+s,e+i,t+s-r,e+i,r]}),this.paths.push({type:"arcTo",args:[t,e+i,t,e+i-o,o]}),this.paths.push({type:"arcTo",args:[t,e,t+n,e,n]})}}};const o={Scene:class{constructor(t,{width:e,height:s,hd:i=!0}){if(!(t&&t instanceof HTMLElement))throw new Error("不能找到匹配的 DOM 元素");const h=document.createElement("canvas");this.ctx=h.getContext("2d"),this.width=e,this.height=s,this.shapes=[],this._initHd(h,i),this._initEvent(h),t.appendChild(h)}_initHd(t,e){if(!e)return;const s=window.devicePixelRatio;t.style.width=this.width+"px",t.style.height=this.height+"px",t.width=this.width*s,t.height=this.height*s,this.ctx.scale(s,s),this.ctx.save()}_initEvent(t){this.hoverShapeSet=new Set,t.addEventListener("click",this.onClick.bind(this)),t.addEventListener("mousemove",this.onMouseMove.bind(this))}_traverseShapes(t){const e=this.shapes.length;for(let s=0;s<e;s++){const e=this.shapes[s];"function"==typeof t&&t(e)}}append(t){this.loop||(this.loop=new a(this.update.bind(this)),this.loop.start()),this.shapes.push(t)}clear(){this.ctx.clearRect(0,0,this.width,this.height)}update(){this.ctx.clearRect(0,0,this.width,this.height),this._traverseShapes(t=>t.draw(this.ctx))}onClick(t){this._traverseShapes(e=>{e.events.click&&e.isPointInPath(t)&&e.dispatchEvent("click")})}onMouseMove(t){this._traverseShapes(e=>{(e.events.mousemove||e.events.mouseenter||e.events.mouseleave)&&(e.isPointInPath(t)?(this.hoverShapeSet.has(e)||e.dispatchEvent("mouseenter"),e.dispatchEvent("mousemove"),this.hoverShapeSet.add(e)):this.hoverShapeSet.has(e)&&(e.dispatchEvent("mouseleave"),this.hoverShapeSet.delete(e)))})}},shapes:r};export default o;
